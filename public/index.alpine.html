<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <!-- JavaScript Bundle with Popper -->

  <script src="//unpkg.com/alpinejs" defer></script>

  <title>Git Commit</title>
</head>

<body @hashchange.window="pageChangeHandler" x-data="init">

  <div class="container">
    <nav class="navbar navbar-light bg-light">
      <a href="#"><span class="navbar-brand mb-0 h1" x-text="title"></span></a>
      <a href="#manage">Manage</a>

    </nav>

    <div class="row mt-4">
      <div class="col">
        <template x-for="alert in alerts">
          <div x-bind:class="`alert alert-${alert.status}`" role="alert">
            <span x-text="alert.message"></span>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close" @click="alerts=[]">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        </template>

        <section x-show="page === '#manage'">
          <form x-on:submit="saveGroup">
            <div class="form-group">
              <label>Batch Name</label>
              <input type="text" x-model="form.name" class="form-control" placeholder="Batch Name">
              <small class="form-text text-muted">contoh: RMT-15-OSLO-FOX</small>
            </div>
            <div class="form-group">
              <label>List users</label>
              <textarea name="" x-model="form.text" class="form-control" id="" cols="100" rows="10"
                x-on:change="pasteHandler"></textarea>
              <small class="form-text text-muted">masuk ke googlesheets phase 2 > sheets final notes > select dari nama
                B4 - UsernameGithub terakhir</small>
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
          </form>
        </section>

        <section x-show="page === ''">
          <select class="custom-select" x-model="selectedRepo" x-init="fetchRepoCommits" @change="selectRepoHandler">
            <option selected>Choose...</option>
            <template x-for="repo in Object.keys(repos)">
              <option :value="repo" x-text="repo"></option>
            </template>

          </select>
          <div class="row mt-4">
            <table class="table mt-4">
              <thead>
                <tr>
                  <th scope="col">#</th>
                  <th scope="col" @click="sort('selectedRepoBranches', 'branch_name')">
                    <div class="d-flex align-items-center">
                      Name
                      <div class="arrow-up ml-3" x-show="sortSelected == 'branch_name' && sortDirection == 1"></div>
                      <div class="arrow-down ml-3" x-show="sortSelected == 'branch_name' && sortDirection == -1"></div>
                    </div>

                  </th>
                  <th scope=" col" @click="sort('selectedRepoBranches', 'commits')">
                    <div class="d-flex align-items-center">
                      Jumlah Commit
                      <div class="arrow-up ml-3" x-show="sortSelected == 'commits' && sortDirection == 1"></div>
                      <div class="arrow-down ml-3" x-show="sortSelected == 'commits' && sortDirection == -1"></div>
                    </div>
                  </th>
                  <th scope="col">Action</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="(branch, index) in selectedRepoBranches ">
                  <tr>
                    <td scope="row" x-text="index+1"></td>
                    <td x-text="branch.branch_name"></td>
                    <td x-text="branch.commits.length"></td>
                    <td>
                      <div style="cursor: pointer" class="btn btn-info text-white pointer">
                        compare</div>
                    </td>

                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <!-- <table class="table mt-4">
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">Nama</th>
                <th scope="col">Status</th>
                <th scope="col">Email</th>
                <th scope="col">Nyawa</th>
                <th scope="col">Github</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="(user, index) in users">

                <tr>
                  <th scope="row" x-text="index+1"></th>
                  <th x-text="user[0]"></th>
                  <th x-text="user[1]"></th>
                  <th x-text="user[2]"></th>
                  <th x-text="user[3]"></th>
                  <th x-text="user[4]"></th>
                  <th>
                    <a :href="`#github_${user[4]}`" class="btn btn-info">Commit</a>
                  </th>

                </tr>
              </template>

            </tbody>
          </table> -->
          <span x-show="selectedRepoBranches.length < 1" class="d-block text-center"> Please select repo</span>
        </section>
        <section x-show="page.includes('github_')">
          <h2 x-text='`Commit Activity - ${location.hash.split("_")[1]}`'></h2>
        </section>
      </div>
    </div>
  </div>

</body>
<script>
  const DATA_KEY = "h8cohorts"

  function init() {
    let cohorts = localStorage[DATA_KEY] || "{}"
    cohorts = JSON.parse(cohorts)

    return {
      base_url: "https://daily-commit-rb.herokuapp.com/",
      sortDirection: 1,
      sortSelected: null,
      users: [],
      alerts: [],
      repos: {},
      selectedRepo: null,
      selectedRepoBranches: [],
      cohorts: Object.keys(cohorts),
      dropdown: false,
      title: "GCH - Git Commit History",
      page: location.hash,
      form: {
        name: '',
        text: ''
      },
      selectRepoHandler() {
        this.selectedRepoBranches = this.repos[this.selectedRepo]
      },
      sort(data, key) {
        console.log(this.sortDirection);
        this[data] = this[data].sort((b, a) => {
          if (key === "commits") {
            return a[key].length < b[key].length ? -this.sortDirection : this.sortDirection
          } else {
            return a[key] < b[key] ? -this.sortDirection : this.sortDirection
          }
        })
        this.sortDirection = -this.sortDirection
        this.sortSelected = key

      },
      fetchRepoCommits() {
        let url = this.base_url + '/hooks/github'
        fetch(url, {
          method: "POST",
          body: JSON.stringify({ cache: true })
        })
          .then(resp => resp.json())
          .then(data => {
            this.repos = data
          })

      },
      getGroups() {
        let cohorts = localStorage[DATA_KEY]
        cohorts = JSON.parse(cohorts)
        return Object.keys(cohorts)
      },
      cohortSelectHandler(event) {

      },
      pasteHandler(event) {
        let text = event.target.value
        let rows = text.split('\n').map(row => {
          return row.split('\t')
        })
        this.users = rows
      },
      pageChangeHandler(event) {
        this.page = location.hash
      },
      saveGroup() {
        try {
          let cohorts = localStorage[DATA_KEY] || "{}"
          cohorts = JSON.parse(cohorts)
          cohorts[this.form.name] = this.users
          localStorage.setItem(DATA_KEY, JSON.stringify(cohorts))
          this.cohorts = Object.keys(cohorts)
          this.alerts.push({ status: 'success', message: 'Successfully add' })
        } catch (error) {
          this.alerts.push({ status: 'danger', message: error.message })
        }
        setTimeout(() => {
          this.alert = []
        }, 2000);
      }
    }
  }
</script>
<style>
  .arrow-up {
    width: 0;
    height: 0;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;

    border-bottom: 5px solid black;
  }

  .arrow-down {
    width: 0;
    height: 0;
    border-left: 5px solid transparent;
    border-right: 5px solid transparent;

    border-top: 5px solid black;
  }
</style>

</html>